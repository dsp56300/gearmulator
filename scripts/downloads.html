<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Gearmulator Downloads</title>
<style>
  body { font-family: sans-serif; }
  select { margin-right: 1em; }
  ul { list-style-type: none; padding: 0; }
</style>
</head>
<body>

<h1>Gearmulator Downloads</h1>

<label>Product: <select id="productFilter"><option value="">All</option></select></label>
<label>Format: <select id="formatFilter"><option value="">All</option></select></label>
<label>OS: <select id="osFilter"><option value="">All</option></select></label>

<ul id="assetList"></ul>

<script>
async function main() {
    const params = new URLSearchParams(window.location.search);
    const version = params.get('version');
    if (!version) {
        document.body.innerHTML = '<p>No version specified in URL</p>';
        return;
    }

    const preProduct = params.get('product') || '';
    const preFormat = params.get('format') || '';
    const preOS = params.get('os') || '';

    const repo = 'dsp56300/gearmulator';
    const url = `https://api.github.com/repos/${repo}/releases/tags/${version}`;
    const resp = await fetch(url);
    const data = await resp.json();

    const assetList = document.getElementById('assetList');
    const productFilter = document.getElementById('productFilter');
    const formatFilter = document.getElementById('formatFilter');
    const osFilter = document.getElementById('osFilter');

    const validFormats = new Set(['AU','CLAP','LV2','VST2','VST3']);
    const products = new Set();
    const formats = new Set();
    const oses = new Set();

    const assets = data.assets.map(a => {
        const name = a.name;
        const parts = name.split('-');

        // Extract product (second part)
        const product = parts[1] || '';

        // Extract format (third part) but only if in validFormats
        const maybeFormat = parts[2] || '';
        const format = validFormats.has(maybeFormat) ? maybeFormat : '';

		const osIndex = format === '' ? 3 : 4;
        // Extract OS (fifth part, or fourth part if no format, remove extension if any)
        let os = parts[osIndex] || '';
        os = os.replace(/\.[^/.]+$/, ''); // remove file extension

        if (product) products.add(product);
        if (format) formats.add(format);
        if (os) oses.add(os);

        return { name, url: a.browser_download_url, product, format, os };
    });

    function populateFilter(select, items, preValue) {
        [...items].sort().forEach(i => {
            const opt = document.createElement('option');
            opt.value = i; opt.textContent = i;
            if (i === preValue) opt.selected = true;
            select.appendChild(opt);
        });
    }

    populateFilter(productFilter, products, preProduct);
    populateFilter(formatFilter, formats, preFormat);
    populateFilter(osFilter, oses, preOS);

    function render() {
        assetList.innerHTML = '';
        const p = productFilter.value;
        const f = formatFilter.value;
        const o = osFilter.value;

        assets.forEach(a => {
            if ((p === '' || a.product === p) &&
                (f === '' || a.format === f) &&
                (o === '' || a.os === o)) {
                const li = document.createElement('li');
                const link = document.createElement('a');
                link.href = a.url;
                link.textContent = a.name;
                li.appendChild(link);
                assetList.appendChild(li);
            }
        });
    }

    productFilter.addEventListener('change', render);
    formatFilter.addEventListener('change', render);
    osFilter.addEventListener('change', render);

    render();
}

main();
</script>

</body>
</html>
