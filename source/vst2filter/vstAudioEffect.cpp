#include "vstAudioEffect.h"
#include <stdio.h>
#include <math.h>

void get_coeffs(long long *coeffs,int freq,int res,int gain=0x400000)
{
	int lut_out[288]={0x3FC30C,0x3FB33D,0x3F9F59,0x3F8651,0x3F66D6,0x3F3F43,0x3F0D8A,0x3ECF1C,0x3E80CB,0x3E1EAA,0x3DA3E4,0x3D0A8D,0x3C4B79,0x3B5E0E,0x3A381E,0x38CDDD,0x3711F7,0x34F5F1,0x326AEF,0x2F6320,0x2BD3F5,0x27B978,0x231AD3,0x1E102A,0x18C9D3,0x13995E,0x0EFF21,0x0BC596,0x0B4940,0x105828,0x226BFB,0x3A908B,0x3FCF90,0x3FC2FF,0x3FB32E,0x3F9F45,0x3F8639,0x3F66B8,0x3F3F1D,0x3F0D5A,0x3ECEE0,0x3E8081,0x3E1E50,0x3DA376,0x3D0A0C,0x3C4AE8,0x3B5D78,0x3A379F,0x38CDB4,0x3712A5,0x34F872,0x32712C,0x2F70A6,0x2BEF42,0x27EE1F,0x237CFE,0x1EC23A,0x1A0586,0x15BF94,0x12B693,0x1240C9,0x1701BD,0x275536,0x3BA4FD,0x3FE4BF,0x3FDDAB,0x3FD4C1,0x3FC989,0x3FBB68,0x3FA9A0,0x3F9340,0x3F771B,0x3F53B6,0x3F273C,0x3EEF5F,0x3EA947,0x3E5169,0x3DE36F,0x3D5A05,0x3CAEBB,0x3BD9DE,0x3AD263,0x398DF9,0x380155,0x3620F3,0x33E29F,0x31402C,0x2E3C1A,0x2AE8F4,0x2774BA,0x243A5F,0x21DE13,0x21812B,0x2530A5,0x30D9D7,0x3D8381,0x3FF0AB,0x3FECAF,0x3FE7AB,0x3FE159,0x3FD964,0x3FCF5F,0x3FC2C2,0x3FB2E1,0x3F9EE4,0x3F85C0,0x3F6621,0x3F3E63,0x3F0C76,0x3ECDCE,0x3E7F42,0x3E1CF1,0x3DA21F,0x3D091E,0x3C4B36,0x3B60BA,0x3A414C,0x38E49A,0x3743EE,0x355D22,0x3337F1,0x30EEF8,0x2EBE7B,0x2D1BE1,0x2CDADA,0x2F66F2,0x370404,0x3E9701,0x3FF760,0x3FF523,0x3FF250,0x3FEEC2,0x3FEA47,0x3FE4A3,0x3FDD88,0x3FD496,0x3FC952,0x3FBB24,0x3FA94B,0x3F92D7,0x3F769A,0x3F531B,0x3F2687,0x3EEE98,0x3EA883,0x3E50E1,0x3DE39C,0x3D5BEA,0x3CB464,0x3BE765,0x3AEFDB,0x39CB09,0x387BE6,0x37113A,0x35B017,0x34A4A8,0x347AD3,0x361AD2,0x3AC9A2,0x3F3403,0x3FFB26,0x3FF9E4,0x3FF84D,0x3FF64D,0x3FF3C8,0x3FF09B,0x3FEC9C,0x3FE793,0x3FE13B,0x3FD93E,0x3FCF2F,0x3FC286,0x3FB298,0x3F9E8D,0x3F855A,0x3F65B0,0x3F3DF4,0x3F0C29,0x3ECDE8,0x3E8058,0x3E2033,0x3DA9F3,0x3D1A49,0x3C6F15,0x3BA975,0x3AD18A,0x39FD36,0x395B07,0x39418D,0x3A3D9A,0x3D0404,0x3F8CFA,0x3FFD46,0x3FFC90,0x3FFBAC,0x3FFA8C,0x3FF921,0x3FF758,0x3FF518,0x3FF242,0x3FEEB0,0x3FEA32,0x3FE488,0x3FDD67,0x3FD46D,0x3FC921,0x3FBAEA,0x3FA90B,0x3F9298,0x3F766E,0x3F532A,0x3F2725,0x3EF072,0x3EACFC,0x3E5ABB,0x3DF84B,0x3D8618,0x3D08A0,0x3C8C85,0x3C2D3D,0x3C1E3B,0x3CB23B,0x3E4DF3,0x3FBF38,0x3FFF91,0x3FFF75,0x3FFF50,0x3FFF23,0x3FFEE9,0x3FFEA1,0x3FFE45,0x3FFDD2,0x3FFD41,0x3FFC8B,0x3FFBA5,0x3FFA83,0x3FF916,0x3FF74B,0x3FF508,0x3FF230,0x3FEE9D,0x3FEA1F,0x3FE47C,0x3FDD70,0x3FD4A9,0x3FC9CC,0x3FBC81,0x3FAC85,0x3F99DF,0x3F8541,0x3F70BA,0x3F60E1,0x3F5E60,0x3F76FA,0x3FBA6F,0x3FF5B7,0x3FFFD4,0x3FFFC8,0x3FFFBA,0x3FFFA8,0x3FFF91,0x3FFF74,0x3FFF50,0x3FFF22,0x3FFEE8,0x3FFEA0,0x3FFE44,0x3FFDD1,0x3FFD3F,0x3FFC88,0x3FFBA2,0x3FFA80,0x3FF913,0x3FF749,0x3FF50A,0x3FF23B,0x3FEEBB,0x3FEA66,0x3FE518,0x3FDEB7,0x3FD744,0x3FCF06,0x3FC6D0,0x3FC077,0x3FBF77,0x3FC950,0x3FE445,0x3FFBE8};
	unsigned int lut2_out[32]={0x7FFFE3,0x7FFFD2,0x7FFFB6,0x7FFF8B,0x7FFF47,0x7FFEDA,0x7FFE2D,0x7FFD1A,0x7FFB67,0x7FF8B3,0x7FF469,0x7FED9B,0x7FE2CD,0x7FD1A7,0x7FB670,0x7F8B40,0x7F46BD,0x7EDA13,0x7E2DD6,0x7D1D0B,0x7B6D94,0x78C49B,0x74957F,0x6E09EB,0x63E3A0,0x545F4B,0x3D321B,0x1BE75F,0xFFEF3AB3,0xFFBA83AA,0xFF8C2A7D,0xFF8040A9};

	freq=(freq>>10)&0x1FFF;
	int freq_off=(freq>>8);
	int lut_off=((res>>15)&0xe0)+freq_off;
	long long frac_a=(freq<<15)&0x7F8000;
	if (freq_off==0x1f) frac_a=0;	// assumed - not from actual code: don't interpolate past the end of the table.
	long long  frac_b=(res<<3)&0x7FFFF8;

	int c00=lut_out[lut_off],c01=lut_out[lut_off+1],c10=lut_out[lut_off+32],c11=lut_out[lut_off+33];
	int d0=lut2_out[freq_off],d1=lut2_out[freq_off+1];

	long long t1=(c00*0x800000ll+frac_a*(c01-c00));
	long long t1s=t1>>23;
	long long t2=(c10*0x800000ll+frac_a*(c11-c10))>>23;

	long long a = (-(t1 + frac_b*(t2-t1s)))<<1;
	long long b=(d0*0x800000ll + frac_a*(d1-d0))>>23;
	long long t3=(0x400000000000ll-a);
	b=((t3>>24)*b)<<1;
	a=a>>24;
	long long t4=(t3-b)>>25;
	b=b>>24;
	long long c=(t4*gain)>>23;
	long long d=c>>1;
		
	coeffs[4]=a;
	coeffs[3]=b;
	coeffs[2]=d;
	coeffs[1]=c;
	coeffs[0]=d;
}

//-------------------------------------------------------------------------------------------------------
AudioEffect* createEffectInstance (audioMasterCallback audioMaster) {return new VSTAudioEffect (audioMaster);}

//-------------------------------------------------------------------------------------------------------
VSTAudioEffect::VSTAudioEffect (audioMasterCallback am) : AudioEffectX(am, 0, 3)	// 0 programs, 0 parameters
{
	setNumInputs  (2);					// stereo input
	setNumOutputs (2);					// stereo output

	setUniqueID   ('tusF');				// identify - The Unknown Suspects Filter
	canProcessReplacing ();				// supports replacing output
	params[0]=0.9;
	params[1]=0;
	params[2]=0.5;
}


//-----------------------------------------------------------------------------------------
void VSTAudioEffect::getParameterName (VstInt32 index, char* label)
{
	switch (index)
	{
	case 0: strcpy(label,"Freq");	return;
	case 1: strcpy(label,"Res");	return;
	case 2: strcpy(label,"Gain");	return;
	}
}

//-----------------------------------------------------------------------------------------
void VSTAudioEffect::getParameterDisplay (VstInt32 index, char* text)
{
	sprintf(text,"%.2f",params[index]);
}


void VSTAudioEffect::resume()
{
	for (int i=0;i<4;i++) hist[i]=0;
	for (int i=0;i<3;i++) vals[i]=params[i];
	get_coeffs(coeffs,0x7fffff*vals[0],0x7fffff*vals[1],0x7fffff*vals[2]);
}

int clamp(int min,int val,int max) {return (val<min)?min:(val>max)?max:val;}

//-----------------------------------------------------------------------------------------
void VSTAudioEffect::processReplacing (float** inputs, float** outputs, VstInt32 sampleFrames)
{
	float *in1=inputs[0],*in2=inputs[1],*out1=outputs[0],*out2=outputs[1];
	float slew=4096.0;
	
	while (sampleFrames)
	{
		bool diff=false;
		for (int i=0;i<3;i++) if (vals[i]!=params[i]) diff=true;
		
		int toprocess=diff?4:sampleFrames;
		if (toprocess>sampleFrames) toprocess=sampleFrames;
		
		if (diff)
		{
			for (int i=0;i<3;i++)
			{
				if (vals[i]==params[i]) continue;
				float diff=params[i]-vals[i];
				float inc=fmin(fmax(-1,diff*slew),1)/slew;
				if (slew*fabs(diff)<1) vals[i]=params[i]; else vals[i]+=inc;
			}
			get_coeffs(coeffs,8388607.f*vals[0],8388607.f*vals[1],8388607.f*vals[2]);
		}
		
		for (int i=0;i<toprocess;i++)
		{
			float in=(*in1++) + (*in2++);
			in=fmin(fmax(-1,in),1);
			long audio_in=floor(0x7FFFFF*in);
			long long a=audio_in*coeffs[0]+hist[0]*coeffs[1]+hist[1]*coeffs[2]+hist[2]*coeffs[3]+hist[3]*coeffs[4];
			a=(a<<2) + 0x400000;
			a=clamp(-8388608,a>>24,8388607);
			hist[1]=hist[0];hist[0]=audio_in;
			hist[3]=hist[2];hist[2]=a&0xFFFFFFFF;
			float audio_out=a/8388608.0;
			*out1++=audio_out;
			*out2++=audio_out;
		}
				
		sampleFrames-=toprocess;		
	}
}
